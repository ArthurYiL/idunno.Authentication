# Build, test and package idunno.Authentication nuget packages

trigger:
- master
- rel/*

pr:
- master
- rel/*

variables:
  solution: '**/*.sln'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

stages:
- stage: Build
  jobs:
  - job: Build
    pool:
      vmImage: 'windows-latest'

    steps:
    # Setup Root CA for tests
    - task: PowerShell@2
      displayName: 'Setup Test Certificate Authority'
      inputs:
        filePath: installTestRootCA.ps1

    - task: UseDotNet@2
      displayName: 'Install .NET Core 3.x SDK'
      inputs:
        packageType: 'sdk'

    - task: UseDotNet@2
      displayName: 'Install .NET Core 2.x Runtime'
      inputs:
        version: '2.2.x'
        packageType: runtime

    # Build
    - task: DotNetCoreCLI@2
      displayName: dotnet build
      inputs:
        command: build
        projects: '**/*.csproj'
        arguments: '--configuration Release'

    # Pack deterministic packages
    - task: DotNetCoreCLI@2
      displayName: "dotnet pack"
      inputs:
        command: 'pack'
        arguments: '--configuration $(buildConfiguration) /p:PackageOutputPath=$(Build.ArtifactStagingDirectory)'
        verbosityPack: minimal
        packagesToPack: '**/src/**/*.csproj'
        nobuild: true

    # Test and publish test results
    # Have to rebuild because Coverlet doesn't like deterministic builds
    # See https://github.com/tonerdo/coverlet/issues/363
    - task: DotNetCoreCLI@2
      displayName: dotnet test
      inputs:
        command: test
        projects: '**/test/**/*.csproj'
        arguments: '/p:ContinuousIntegrationBuild=false --configuration $(buildConfiguration) --settings $(Build.SourcesDirectory)/CodeCoverage.runsettings --collect:"XPlat Code Coverage" -- RunConfiguration.DisableAppDomain=true'

    - task: PublishCodeCoverageResults@1
      displayName: 'Publish code coverage'
      inputs:
        codeCoverageTool: Cobertura
        summaryFileLocation: $(Agent.TempDirectory)/**/coverage.cobertura.xml

    # Publish packages
    - publish: $(Build.ArtifactStagingDirectory)
      displayName: Publish artifacts
      artifact: BuildPackages
